# Use Cases
## 一問一答フォーム作成・分析ツール（Phase1）

---

## 0. 目的

本書は、本プロジェクトMVPにおけるユースケース（利用場面）を定義し、
要求定義（Phase1）の基礎とする。

- アクター（利用者）とシステムの相互作用を明確化する
- 正常系だけでなく、代替フロー・例外フローを明文化する
- 受入基準・テストシナリオへ接続できる粒度で定義する

---

## 1. 前提と用語

### 1.1 アクター（Actor）

- 教師（Teacher）：問題作成、クイズ作成、配布、結果閲覧を行う
- 生徒（Student）：クイズへ回答し、（MVP範囲内で）結果を閲覧する

※ 教務管理者（Admin）はMVPでは対象外

### 1.2 用語（Glossary）

- Question：一問（設問）
- Quiz：問題セット（小テスト）
- Attempt：生徒1名によるQuizへの回答1回
- AttemptAnswer：Attempt内の各設問の回答レコード
- CorrectRate：設問別正答率

---

## 2. ユースケース一覧（MVP）

| UC ID | 名称 | 主アクター | 概要 |
|------:|------|------------|------|
| UC-01 | 問題を登録する | 教師 | 問題（Question）を登録する |
| UC-02 | クイズを作成する | 教師 | 複数問題からクイズ（Quiz）を作成する |
| UC-03 | フォームを生成・配布する | 教師 | QuizからGoogleフォームを生成し配布する |
| UC-04 | 生徒が回答する | 生徒 | フォームへ回答し提出する |
| UC-05 | 自動採点する | システム | 回答送信をトリガーに採点し保存する |
| UC-06 | 結果を集計・閲覧する | 教師 | 個人別得点・設問別正答率を閲覧する |

---

## 3. ユースケース詳細

### UC-01 問題を登録する（Create Question）

**主アクター**：教師  
**目的**：一問一答の設問を登録し、後のクイズ作成で再利用可能にする。  
**トリガー**：教師が「問題登録」操作を行う。  
**事前条件**：
- 教師が問題登録用の入力手段にアクセスできる（例：スプレッドシート、簡易フォーム、メニューUI等）。
- 変更権限を教師のみが持つ。  
**事後条件**：
- Questionsに1件のQuestionが登録される。
- `questionId` が一意に付与される。

**入力（必須）**：
- 問題文
- 選択肢（2〜5程度を想定）
- 正解（選択肢のいずれか）

**入力（任意）**：
- 解説
- タグ（複数可）
- 難易度（手動）

#### 基本フロー（Main）
1. 教師は問題文、選択肢、正解を入力する。
2. システムは入力妥当性を検証する。
3. システムは `questionId` を生成する（UUID推奨）。
4. システムは Questions に登録する。
5. システムは登録成功を教師へ通知する。

#### 代替フロー（Alternative）
- A1：任意項目（解説、タグ、難易度）を省略して登録する  
  - 2〜5は同様に進行する。

#### 例外フロー（Exception）
- E1：必須項目が未入力  
  - システムは登録せず、未入力項目を通知する。
- E2：選択肢が不足（例：1件以下）  
  - システムは登録せず、選択肢数の要件を通知する。
- E3：正解が選択肢と整合しない  
  - システムは登録せず、整合性エラーを通知する。

---

### UC-02 クイズを作成する（Create Quiz）

**主アクター**：教師  
**目的**：登録済み問題から小テスト（Quiz）を作成する。  
**トリガー**：教師が「クイズ作成」操作を行う。  
**事前条件**：
- 1件以上のQuestionが登録済みである。  
**事後条件**：
- QuizzesにQuizが登録される。
- QuizQuestions（関連）に、QuizとQuestionの紐付けが登録される。
- `quizId` が一意に付与される。

**入力（必須）**：
- クイズタイトル
- 出題するQuestionの選択（例：10問）

**入力（任意）**：
- 回答期限
- 設定（再回答可否、シャッフル等 ※MVPでは固定でも可）

#### 基本フロー（Main）
1. 教師はクイズタイトルを入力する。
2. 教師は登録済みのQuestionから出題問題を選択する。
3. システムは `quizId` を生成する。
4. システムは Quizzes に登録する。
5. システムは QuizQuestions に関連（順序を含む）を登録する。
6. システムは登録成功を教師へ通知する。

#### 代替フロー（Alternative）
- A1：回答期限を未設定で作成する  
  - 3〜6は同様に進行する。

#### 例外フロー（Exception）
- E1：選択されたQuestionが0件  
  - システムは作成せず、最低出題数要件を通知する。
- E2：同一Questionが重複選択  
  - システムは重複を除外するか、エラーとして通知する（仕様はrequirements-specで確定）。
- E3：登録処理失敗（シート書き込み失敗等）  
  - システムは作成せず、エラーをログに記録し教師へ通知する。

---

### UC-03 フォームを生成・配布する（Generate & Publish Form）

**主アクター**：教師  
**目的**：QuizからGoogleフォームを自動生成し、生徒に配布できる状態にする。  
**トリガー**：教師が「フォーム生成」操作を行う。  
**事前条件**：
- 対象のQuizが存在する。
- Quizに紐付くQuestionが存在する。  
**事後条件**：
- Googleフォームが生成される。
- 回答先スプレッドシートが紐付く。
- フォームURL（配布用）が取得できる。

**入力**：
- 対象Quizの選択
- （任意）フォーム設定（回答期限など：MVPでは固定でも可）

#### 基本フロー（Main）
1. 教師は対象のQuizを選択する。
2. システムはQuizQuestionsを取得し、設問順序を確定する。
3. システムはGoogleフォームを新規作成する。
4. システムは各Questionをフォーム項目として追加する。
5. システムは回答先スプレッドシートを紐付ける。
6. システムはフォームURLを教師へ提示する。

#### 代替フロー（Alternative）
- A1：既存フォームを再生成（再配布）する  
  - 既存フォームを再利用するか、新規作成するかは仕様で確定（MVPは新規作成推奨）。

#### 例外フロー（Exception）
- E1：Quizに紐付くQuestionが存在しない  
  - システムは生成せず、Quiz構成の不備を通知する。
- E2：フォーム生成失敗（FormAppエラー）  
  - システムは失敗をログに記録し、教師へ通知する。
- E3：回答先スプレッドシート紐付け失敗  
  - システムは失敗をログに記録し、教師へ通知する。

---

### UC-04 生徒が回答する（Submit Attempt）

**主アクター**：生徒  
**目的**：配布されたフォームへ回答し提出する。  
**トリガー**：生徒がフォームURLを開く。  
**事前条件**：
- フォームが配布済みである。
- （識別方式により）生徒識別情報を取得できる。  
**事後条件**：
- 回答がフォーム回答シートに保存される。
- 採点トリガーが起動する（UC-05へ）。

**入力**：
- 設問への回答（選択）
- （必要な場合）学生ID等の識別子

#### 基本フロー（Main）
1. 生徒はフォームを開き、設問に回答する。
2. 生徒は送信する。
3. システム（Googleフォーム）は回答を保存する。
4. onFormSubmitトリガーが起動し、UC-05へ遷移する。

#### 代替フロー（Alternative）
- A1：未回答がある状態で送信しようとする  
  - 必須設定の有無により、送信不可または未回答を許容（仕様で確定）。

#### 例外フロー（Exception）
- E1：期限切れ  
  - 期限運用を行う場合、フォーム側または採点側で無効扱い（仕様で確定）。
- E2：識別子未入力（学生ID方式の場合）  
  - 送信不可（フォーム必須）または採点側でエラー（仕様で確定）。

---

### UC-05 自動採点する（Auto Score Attempt）

**主アクター**：システム  
**目的**：提出された回答を採点し、Attempt/AttemptAnswersとして保存する。  
**トリガー**：フォーム送信（onFormSubmit）。  
**事前条件**：
- QuizとQuestionの正解情報が参照可能である。  
**事後条件**：
- AttemptsにAttemptが保存される。
- AttemptAnswersに設問単位の結果が保存される。
- 合計得点が算出される。

#### 基本フロー（Main）
1. システムは送信イベントから回答データを取得する。
2. システムは対象Quizを特定する（回答シート紐付け等により）。
3. システムは `attemptId` を生成する。
4. システムは各設問について正誤判定し、AttemptAnswersを作成する。
5. システムは合計得点を算出し、Attemptを保存する。
6. （任意）集計キャッシュを更新する（UC-06の閲覧を高速化）。

#### 代替フロー（Alternative）
- A1：採点は保存のみ行い、集計はバッチで行う  
  - 集計更新を省略し、別トリガーで集計する（性能要件次第）。

#### 例外フロー（Exception）
- E1：回答データに対応するQuestionが特定できない  
  - 採点を中断し、エラーをログに記録し教師へ通知する。
- E2：同時実行衝突（シート書き込み競合）  
  - LockService等で排他し、再試行または失敗ログを残す（実装方針）。
- E3：実行時間超過  
  - 採点を軽量化し、集計をバッチ化する（方針転換）。

---

### UC-06 結果を集計・閲覧する（View Results & Analytics）

**主アクター**：教師  
**目的**：個人別得点と設問別正答率を閲覧する。  
**トリガー**：教師が「結果閲覧」操作を行う。  
**事前条件**：
- Attempts / AttemptAnswers が保存されている。  
**事後条件**：
- 集計結果が表示される（スプレッドシート出力またはレポート）。

**出力（MVP）**：
- 個人別得点一覧（Attempt単位または生徒単位：仕様で確定）
- 設問別正答率
- クラス平均点

#### 基本フロー（Main）
1. 教師は対象Quiz（または期間）を選択する。
2. システムはAttempts/AttemptAnswersを取得する。
3. システムは集計値（正答率、平均点など）を算出する。
4. システムは集計結果をシートへ出力または表示する。

#### 代替フロー（Alternative）
- A1：集計キャッシュを参照して表示する  
  - 既計算値を表示し、必要に応じて再計算する。

#### 例外フロー（Exception）
- E1：対象QuizにAttemptが存在しない  
  - 空結果として表示し、未実施である旨を通知する。
- E2：集計対象データが破損（欠損・整合性不良）  
  - エラーをログに記録し、再計算のための復旧手順を提示する（MVPは通知のみでも可）。

---

## 4. 未確定事項（Phase1で確定する）

以下は要件確定（requirements-spec.md）で結論を出す：

- 生徒識別方式（Googleログイン / 学生ID / 匿名）
- 複数回回答の扱い（禁止 / 最新のみ / 全履歴）
- 未回答の扱い（分母に含めるか等）
- 問題の更新ポリシー（更新可否、複製ルール）
- フォーム再生成の扱い（既存再利用 or 新規生成）
- 集計の即時性（リアルタイム更新 or バッチ更新）

---

Author: Takeomi Tamura
Date: 2026/2/23
Version: 0.1